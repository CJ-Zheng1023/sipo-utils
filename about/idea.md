# sipo-utils前端工具库实现思路

目前工具库提供高亮、高密、聚焦、标记、取消标记等跟检索业务密切相关的功能底层api。所有api不涉及具体业务(高亮api会涉及一点业务规则)，只涉及底层实现，实际应用时需根据具体业务进行封装。下面来说一下各个api的实现思路。具体api调用请参考readme。



## 高亮

总体思路：针对入参高亮词根据业务规则构建正则表达式去替换原始文本。找出匹配的文本，对每个字符套span标签，并设置背景色或者border。



1. 首先针对入参高亮词进行双引号的去除。

2. 针对高亮词进行尖括号(<,>)转义操作，即<替换成&lt ;，>替换成&gt ；

3. 针对正则特殊字符进行转义，这里不针对?特殊字符进行处理，因为?(截词符)有业务含义，所以单独处理。

4. 针对输入的高亮词不为?？的情况，首先需要对高亮词按字符进行拆分，并构建正则表达式。例如高亮词为*手机* ，经过拆分之后变成

   ```
   ((<span class="hl"[^<>]+>)+手(</span>)+|手)((<span class="hl"[^<>]+>)+机(</span>)+|机)
   ```

5. 针对截词符(?？#)进行处理处理，替换成具体正则表达式。业务规则为问号表示一个字符或没有，#表示一个英文字母。

6. 针对输入高亮词为?？的情况，这种情况的问号不为截词符，所以要对?进行正则特殊字符转义。

7. 之后进行高亮词拆分构建正则表达式。例如高亮词为?，经过拆分后变成

   ```
   ((<span class="hl"[^<>]+>)+\?(</span>)+|\?)
   ```

8. 针对高亮词里包含w,d关系算符的情况，首先要按照第一个出现的w,d运算符进行拆分会拆出左右两部分，分别针对运算这两部分词进行上面1-7的操作，如果拆出来的词里还包含w,d算符，再次进行拆分，知道不包含为止。最终会生成一个正则表达式。w,d业务规则为例如a 3w d表示a和d之间有最多有3个英文单词或者3个中文字符，a 3d d 表示a 3w d或者d 3w a。目前是按照字符个数实现，后续要实现针对英文单词的匹配。

9. 经过上述处理后会生成正则表达式，把原始文本进行替换。如果高亮词不包含w,d关系算符，则针对匹配文本的每个字符套一个span标签并设置背景色，针对背景色深浅设置字体颜色。如果高亮词包含w,d关系算符，则针对匹配文本的每个字符套一个span标签并设置上下border，针对匹配文本第一个字符设置左border，针对匹配文本最后一个字符设置右border。

   

## 聚焦

总体思路：针对入参聚焦词根据业务规则构建正则表达式去替换原始文本。并为每个匹配文本前加上...



1. 首先针对聚焦词进行尖括号(<,>)转义。

2. 针对正则特殊字符进行转义。

3. 构建正则，例如入参聚焦词为手机、电脑，会生成如下

   ```
   (([^.。！!]*(\.|。|！|!))?[^.。！!]*((手机|电脑)(?![^<>]*>))[^.。！!]*(\.|。|！|!))
   ```

   正则。业务规则为匹配包含聚焦词的句子和前一个句子，前一个句子可有可无。

4. 为匹配的文本前加上...符号。



## 高密

总体思路：计算高亮词在容器里的相对高度，计算百分比。因为高亮底层的改动，高密api需要调整。



## 标记(用于mark笔)

总体思路：根据标记对象获取起始和结尾节点对象，并根据起始和结尾节点对象获取区间，在这区间内找到textNode即纯文本节点套上span标签，并设置标记样式。标记对象结构如下：

```
{id: '', start: {tagName: 'p', tagIndex: 0, offset: 1}, end: {tagName: 'p', tagIndex: 0, offset: 9}}
```

start属性表示起始节点信息，end表示结尾节点信息。tagName表示起始拥有起始节点的最外层容器的直接孩子节点(假设叫node1)的标签名称，tagIndex表示该节点(node1)在父节点下的索引位置，offset表示起始节点在node1下的文本偏移量。



具体业务中的应用：

1. 使用鼠标划选一段文本，调用createMarker方法，生成标记对象。
2. 标记对象存入数据库，同时调用mark方法实现前端标记。
3. 可以通过unmark方法实现前端取消标记，同时调用后端api删除对应的标记对象。
4. 具体调用方法参考readme



目前存在的缺陷：一段文本被标记之后，不能再次划选标记。后续优化。



标记api相关实现思路来源于https://alienzhou.github.io/web-highlighter/